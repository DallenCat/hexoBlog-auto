
---

title: 三、语雀写作，自动部署服务器

urlname: gx17m1

date: 2020-02-22 20:37:44 +0800

tags: []

---
<a name="0cvrY"></a>
## 前文
1. [hexo安装部署到云服务器](http://www.daiailing.cn/2020/02/19/yuque/Hexo+%E8%AF%AD%E9%9B%80+Travis-CI+%E6%9C%8D%E5%8A%A1%E5%99%A8+Serverless%E5%AE%9E%E7%8E%B0%E4%BA%91%E7%AB%AF%E5%86%99%E4%BD%9C%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E7%9A%84%E4%BF%9D%E5%A7%86%E7%BA%A7%E6%95%99%E7%A8%8B/)
1. [Travis-CI监听github仓库变动部署到云服务器](http://www.daiailing.cn/2020/02/22/yuque/Travis-CI%E7%9B%91%E5%90%ACgithub%E4%BB%93%E5%BA%93%E5%8F%98%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/)

<!--more-->

<a name="s2vws"></a>
## 思路

- 在语雀中新建一个知识库，知识库里配置Web Hook。通过配置 [Web Hook](https://yuque.com/yuque/developer/doc-webhook)，可以方便地让开发者订阅到此知识库下所有文档、评论等数据变更。
- 在腾讯云上创建 **云函数 ，**通过语雀的Web Hook 去触发云函数
- 云函数中配置了Travis-CI的token，repoid，强制让travis-ci重新restart一次

<br />

在本地git bash拉取hexoBlog-auto

```javascript
git clone git@github.com:DallenCat/hexoBlog-auto.git
```

<a name="lICqn"></a>
## 安装yuque-hexo，配置package.json

- github地址：[yuque-hexo](https://github.com/x-cold/yuque-hexo)

```javascript
npm install yuque-hexo
```

- 修改 `package.json`

```javascript
"scripts": {
        "build": "hexo generate",
        "clean": "hexo clean",
        "server": "hexo server",
        "sync": "yuque-hexo sync",
        "clean:yuque": "yuque-hexo clean",
        "deploy": "npm run sync && hexo clean && hexo g -d"
},
"yuqueConfig": {
        "postPath": "source/_posts/yuque",
        "cachePath": "yuque.json",
        "mdNameFormat": "title",
        "adapter": "hexo",
        "concurrency": 5,
        "baseUrl": "https://www.yuque.com/api/v2",
        "login": "wozaimiaozheli",    //语雀账号
        "repo": "szls99",            //语雀知识库id
        "onlyPublished": false,
        "token": "xxxxxxxxxxxxxxxxxx"     //语雀token
}
```

- `yuqueConfig` 下`login`在语雀右上角头像，账户设置，账户管理，个人路径

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376450619-09e08638-dec1-4a85-919d-b0d40ae12084.png#align=left&display=inline&height=291&name=image.png&originHeight=291&originWidth=289&size=15107&status=done&style=none&width=289)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376474418-695be409-6405-4005-a470-08d03d45fa99.png#align=left&display=inline&height=530&name=image.png&originHeight=530&originWidth=690&size=28533&status=done&style=none&width=690)<br />
<br />

- `repo` 在 知识库，点进你的知识库，上面url中账号后面的英文加数字就是你的repo

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376613622-cd449ad6-cca6-4f43-a56f-4e9621780258.png#align=left&display=inline&height=288&name=image.png&originHeight=288&originWidth=1222&size=26118&status=done&style=none&width=1222)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376644041-0b0ce15e-5eb7-435f-a1ee-c8391bf5823a.png#align=left&display=inline&height=50&name=image.png&originHeight=50&originWidth=466&size=4722&status=done&style=none&width=466)<br />我的repo就是szls99

- `token` 在右上角头像，账户设置中，Token，新建Token，创建，复制

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376883080-66bb4ecc-41df-465a-822b-43e029f1576d.png#align=left&display=inline&height=431&name=image.png&originHeight=431&originWidth=1065&size=26310&status=done&style=none&width=1065)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376906623-6ba2d34d-2c43-4633-af1c-5122ea511bfa.png#align=left&display=inline&height=439&name=image.png&originHeight=439&originWidth=830&size=31312&status=done&style=none&width=830)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582376942006-cc6dab36-2ca8-460c-a71e-9699561e00d9.png#align=left&display=inline&height=388&name=image.png&originHeight=388&originWidth=927&size=29434&status=done&style=none&width=927)


- 附上完整的`package.json`

```javascript
{
    "name": "hexo-site",
    "version": "0.0.0",
    "private": true,
    "scripts": {
        "build": "hexo generate",
        "clean": "hexo clean",
        "server": "hexo server",
        "sync": "yuque-hexo sync",
        "clean:yuque": "yuque-hexo clean",
        "deploy": "npm run sync && hexo clean && hexo g -d"
    },
    "hexo": {
        "version": "4.2.0"
    },
    "dependencies": {
        "hexo": "^4.0.0",
        "hexo-deployer-git": "^2.1.0",
        "hexo-generator-archive": "^1.0.0",
        "hexo-generator-category": "^1.0.0",
        "hexo-generator-index": "^1.0.0",
        "hexo-generator-tag": "^1.0.0",
        "hexo-helper-live2d": "^3.1.1",
        "hexo-renderer-ejs": "^1.0.0",
        "hexo-renderer-marked": "^2.0.0",
        "hexo-renderer-stylus": "^1.1.0",
        "hexo-server": "^1.0.0",
        "live2d-widget-model-koharu": "^1.0.5"
    },
    "yuqueConfig": {
        "postPath": "source/_posts/yuque",
        "cachePath": "yuque.json",
        "mdNameFormat": "title",
        "adapter": "hexo",
        "concurrency": 5,
        "baseUrl": "https://www.yuque.com/api/v2",
        "login": "wozaimiaozheli",
        "repo": "szls99",
        "onlyPublished": false,
        "token": "xxxxxxxxxxxxxxxxxxxxx"
    }
}

```



<a name="i80Ce"></a>
## 创建腾讯云serverless云函数解析

- 新建云函数，模板选择Php7

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582377303799-bc1804de-3cae-414e-99d9-d36105fb2733.png#align=left&display=inline&height=212&name=image.png&originHeight=212&originWidth=1387&size=24186&status=done&style=none&width=1387)<br />
<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582377333679-ada925a6-58a7-4f53-ad36-fccf25508213.png#align=left&display=inline&height=800&name=image.png&originHeight=800&originWidth=1310&size=96991&status=done&style=none&width=1310)

- `serverless` 函数：

```php
<?php
function main_handler($event, $context) {
    // 解析语雀post的数据
    $update_title = '';
    if($event->body){
        $yuque_data= json_decode($event->body);
        $update_title .= $yuque_data->data->title;
    }
    // default params
    $repos = 'xxxx';  // 你的仓库id 或 slug
    $token = 'xxxxxx'; // 你的登录token
    $message = date("Y/m/d").':yuque update:'.$update_title;
    $branch = 'master';
    // post params
    $queryString = $event->queryString;
    $q_token = $queryString->token ? $queryString->token : $token;
    $q_repos = $queryString->repos ? $queryString->repos : $repos;
    $q_message = $queryString->message ? $queryString->message : $message;
    $q_branch = $queryString->branch ? $queryString->branch : 'master';
    echo($q_token);
    echo('===');
    echo ($q_repos);
    echo ('===');
    echo ($q_message);
    echo ('===');
    echo ($q_branch);
    echo ('===');
    //request travis ci
    $res_info = triggerTravisCI($q_repos, $q_token, $q_message, $q_branch);

    $res_code = 0;
    $res_message = '未知';
    if($res_info['http_code']){
        $res_code = $res_info['http_code'];
        switch($res_info['http_code']){
            case 200:
            case 202:
                $res_message = 'success';
            break;
            default:
                $res_message = 'faild';
            break;
        }
    }
    $res = array(
        'status'=>$res_code,
        'message'=>$res_message
    );
    return $res;
}

/*
* @description  travis api , trigger a build
* @param $repos string 仓库ID、slug
* @param $token string 登录验证token
* @param $message string 触发信息
* @param $branch string 分支
* @return $info array 回包信息
*/
function triggerTravisCI ($repos, $token, $message='yuque update', $branch='master') {
    //初始化
    $curl = curl_init();
    //设置抓取的url
    curl_setopt($curl, CURLOPT_URL, 'https://api.travis-ci.org/repo/'.$repos.'/requests');
    //设置获取的信息以文件流的形式返回，而不是直接输出。
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    //设置post方式提交
    curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
    //设置post数据
    $post_data = json_encode(array(
        "request"=> array(
            "message"=>$message,
            "branch"=>$branch
        )
    ));
    $header = array(
      'Content-Type: application/json',
      'Travis-API-Version: 3',
      'Authorization:token '.$token,
      'Content-Length:' . strlen($post_data)
    );
    curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
    curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data);
    //执行命令
    $data = curl_exec($curl);
    $info = curl_getinfo($curl);
    //关闭URL请求
    curl_close($curl);
    return $info;
}
?>
```

- 触发方式选择API网管触发器，得到访问路径，例如：

`https://service-qomnxox2-1300907076.gz.apigw.tencentcs.com/release/yuque-to-hexo`


- `$token` 获取

在Travis-CI官网右上角头像点击`Settings`，再点击`Settings`，复制`API authentication`<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582377685705-585c78d6-6b7d-4762-90a7-f79c3fa8d8a8.png#align=left&display=inline&height=241&name=image.png&originHeight=241&originWidth=261&size=11783&status=done&style=none&width=261)<br />
<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582377772738-f072350b-3af8-43f0-9d99-0445a813e7b8.png#align=left&display=inline&height=213&name=image.png&originHeight=213&originWidth=688&size=13142&status=done&style=none&width=688)<br />
<br />

- `$repos` 获取，27946093就是我的$repos

使用postman 获取 api 接口 https://api.travis-ci.org/owner/你的github账号/repos<br />Headers中添加3个参数<br />Authorization : token `你的travis-ci token`<br />Travis-API-Version : 3<br />User-Agent : API Explorer<br />如下图我传的参数<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582377825861-98fad213-d97c-456b-a88f-d75ddd0623fe.png#align=left&display=inline&height=485&name=image.png&originHeight=485&originWidth=612&size=35345&status=done&style=none&width=612)<br />

<a name="mrB7x"></a>
## 设置语雀知识库web hook

- 打开语雀知识库列表，选择要设置的知识库，设置，开发者，URL填写云函数创建的`API网关触发器的访问路径`

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582378225377-e04fc60c-018f-489a-a136-1250b2525749.png#align=left&display=inline&height=64&name=image.png&originHeight=64&originWidth=1026&size=6130&status=done&style=none&width=1026)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582378424043-8100df58-0bd9-4790-bbd7-3804061d1175.png#align=left&display=inline&height=524&name=image.png&originHeight=524&originWidth=1031&size=46816&status=done&style=none&width=1031)

<a name="g4KZd"></a>
## 发布或更新一篇文章查看测试

- 云函数的运行日志

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582378632100-6324bf8e-016d-431d-9801-97eb22e97c51.png#align=left&display=inline&height=380&name=image.png&originHeight=380&originWidth=1093&size=55940&status=done&style=none&width=1093)<br />

- Travis-CI的运行日志

![image.png](https://cdn.nlark.com/yuque/0/2020/png/933518/1582378683237-d06a1507-cc77-49d5-93e0-bd5044f742c4.png#align=left&display=inline&height=168&name=image.png&originHeight=168&originWidth=979&size=17420&status=done&style=none&width=979)<br />
<br />

<a name="5E4Bo"></a>
## 祝大家江山一片绿，build success

